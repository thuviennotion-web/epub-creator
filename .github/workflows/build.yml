name: Build EPUB

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Trích xuất tiêu đề sách và tạo Slug (Tên file)
        id: slug_maker # Thêm ID cho step này để các step sau gọi tới
        run: |
          SLUG=$(python3 -c "
          import xml.etree.ElementTree as ET
          import re
          
          try:
              tree = ET.parse('src/OEBPS/content.opf')
              title = next(elem.text for elem in tree.iter() if 'title' in elem.tag)
              
              s = title.lower()
              s = re.sub(r'[àáạảãâầấậẩẫăằắặẳẵ]', 'a', s)
              s = re.sub(r'[èéẹẻẽêềếệểễ]', 'e', s)
              s = re.sub(r'[ìíịỉĩ]', 'i', s)
              s = re.sub(r'[òóọỏõôồốộổỗơờớợởỡ]', 'o', s)
              s = re.sub(r'[ùúụủũưừứựửữ]', 'u', s)
              s = re.sub(r'[ỳýỵỷỹ]', 'y', s)
              s = re.sub(r'[đ]', 'd', s)
              
              s = re.sub(r'[^a-z0-9\s-]', '', s)
              s = re.sub(r'[\s-]+', '-', s).strip('-')
              
              print(s)
          except Exception as e:
              print('ebook-mac-dinh') 
          ")
          
          # Ghi vào GITHUB_OUTPUT thay vì GITHUB_ENV
          echo "filename=${SLUG}.epub" >> $GITHUB_OUTPUT
          echo "Tên file tự động tạo là: ${SLUG}.epub"

      - name: Xây dựng file EPUB
        run: |
          cd src
          # Gọi output từ step có id là 'slug_maker'
          zip -X0q ../${{ steps.slug_maker.outputs.filename }} mimetype
          zip -X9rq ../${{ steps.slug_maker.outputs.filename }} META-INF OEBPS
          cd ..

      - name: Tạo bản Release tự động
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ steps.slug_maker.outputs.filename }}
          tag_name: "v1.${{ github.run_number }}"
          name: "Bản cập nhật số ${{ github.run_number }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}